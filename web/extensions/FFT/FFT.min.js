

/* web/extensions/FFT/FFT.min.js */
var fft_a={KRAS:1,NOVO:2,KHAB:3,REVD:4,SEYD:5,MULT:6},fft={ext_name:"FFT",first_time:!0,update_interval:0,cmd_e:{FFT:0,CLEAR:1},func:1,func_e:{OFF:-1,FFT:0,SPEC:1,INTEG:2},func_s:["FFT","spectrum","integrate"],spec_source_save:0,pre:0,pre_4_SEC:0,pre_10_SEC:1,pre_ALPHA:2,pre_s:["integrate 4 s","integrate 10 s","Alpha (RSDN-20)","40 JJY","60 WWVB/MSF/JJY","200/3 RBU","68.5 BPC","77.5 DCF77"],itime:10,maxdb:-10,mindb:-130,data_canvas:null,integ_w:1024,integ_th:200,integ_hdr:12,integ_h:0,integ_yo:0,integ_bins:0,integ_bino:0,integ_draw:!1,integ_last_freq:0,integ_last_offset:0,integ_dbl:0,integ_maxdb:0,integ_mindb:0,info_canvas:null,alpha_stations:["Krasnodar 38°E","Novosibirsk 84°E","Khabarovsk 136°E","Revda 34°E","Seyda 62°E"],alpha_station_colors:["yellow","red","lime","cyan","magenta"],alpha_sched:{0:["F1","F4/5","F2","F3/p"],1:[11.9,12.09,12.65,14.88],2:[!0,!1,!1,!1],3:[fft_a.NOVO,0,fft_a.REVD,fft_a.KRAS],4:[fft_a.SEYD,fft_a.REVD,fft_a.NOVO,fft_a.KHAB],5:[fft_a.KRAS,fft_a.SEYD,fft_a.KHAB,fft_a.NOVO],6:[fft_a.KHAB,0,fft_a.KRAS,fft_a.MULT],7:[fft_a.REVD,0,0,fft_a.SEYD],8:[0,0,fft_a.SEYD,fft_a.REVD]}};function FFT_main(){ext_switch_to_client(fft.ext_name,fft.first_time,fft_recv),fft.first_time?fft.integ_h=fft.integ_th-fft.integ_hdr:fft_controls_setup(),fft.first_time=!1}function fft_clear(){var t;ext_send("SET clear"),fft.integ_draw=!1,(t=fft.data_canvas.ctx).fillStyle="mediumBlue",t.fillRect(0,0,fft.integ_w,fft.integ_th),(t=fft.info_canvas.ctx).fillStyle="#575757",t.fillRect(0,0,256,280);var f=w3_el("fft-controls-left"),e=w3_el("fft-controls-right");switch(fft.pre){case fft.pre_ALPHA:ext_set_controls_width_height(void 0,290),f.style.width="49.9%",e.style.width="49.9%",fft_alpha();break;default:ext_set_controls_width_height(275,290),f.style.width="0%",e.style.width="100%";var _=ext_get_freq();fft_marker((_/1e3).toFixed(2),!1,_)}ext_send("SET run="+fft.func)}function fft_update(){var t=ext_get_freq(),f=t-ext_get_carrier_freq();t==fft.integ_last_freq&&f==fft.integ_last_offset||(fft_clear(),fft.integ_last_freq=t,fft.integ_last_offset=f)}function fft_marker(t,f,e){var _=fft.data_canvas.ctx,a=fft.integ_w/ext_sample_rate();t=f?t+"▼":"▼"+t,_.font="12px Verdana",_.fillStyle="white";var i=(e-ext_get_carrier_freq())*a,n=_.measureText("▼").width/2-(f?-1:2),r=Math.round(fft.integ_w/2-1+i+(f?-_.measureText(t).width+n:-n));_.fillText(t,r,10)}function fft_mousedown(t){var f=(t.clientY?t.clientY:t.offsetY?t.offsetY:t.layerY)-fft.integ_yo;if(!(f<0||f>=fft.integ_h)){var e=Math.round(f/fft.integ_dbl);e<0||e>fft.integ_bins||(fft.integ_bino=Math.round((fft.integ_bino+e)%fft.integ_bins))}}function fft_recv(t){if("DAT"!=arrayBufferToStringLen(t,3))for(var f=arrayBufferToString(t).substring(4).split(" "),e=0;e<f.length;e++){var _=f[e].split("=");switch(_[0]){case"ready":fft_controls_setup();break;case"bins":fft.integ_bins=parseInt(_[1]),fft.integ_bino=0,fft.integ_dbl=Math.floor(fft.integ_h/fft.integ_bins),fft.integ_dbl<1&&(fft.integ_dbl=1),fft.integ_yo=(fft.integ_h-fft.integ_dbl*fft.integ_bins)/2,fft.integ_yo<0&&(fft.integ_yo=0),fft.integ_yo+=fft.integ_hdr,fft.integ_draw=!0;break;default:console.log("fft_recv: UNKNOWN CMD "+_[0])}}else{var a=new Uint8Array(t,4),i=a[0],n=1,r=a.length-1;if(i==fft.cmd_e.FFT){if(!fft.integ_draw)return;if(spec.source_audio){var s=new Uint8Array(t,6);spectrum_update(s)}else{var l=fft.data_canvas.ctx,c=fft.data_canvas.im,o=a[n];n++,r--,(o-=fft.integ_bino)<0&&(o+=fft.integ_bins);for(var d=0;d<fft.integ_w;d++){var u=waterfall_color_index_max_min(a[d+n],fft.integ_maxdb,fft.integ_mindb);c.data[4*d+0]=color_map_r[u],c.data[4*d+1]=color_map_g[u],c.data[4*d+2]=color_map_b[u],c.data[4*d+3]=255}for(var g=0;g<fft.integ_dbl;g++)l.putImageData(c,0,fft.integ_yo+(o*fft.integ_dbl+g))}}else i==fft.cmd_e.CLEAR?fft_clear():console.log("fft_recv: DATA UNKNOWN cmd="+i+" len="+r)}}function fft_controls_setup(){var t=time_display_html("fft")+w3_div("id-fft-data|left:150px; width:1024px; height:200px; background-color:mediumBlue; position:relative;",'<canvas id="id-fft-data-canvas" width="1024" height="200" style="position:absolute"></canvas>'),f=w3_div("id-fft-info|left:0px; height:280px; overflow:hidden; position:relative;",'<canvas id="id-fft-info-canvas" width="256" height="280" style="position:absolute"></canvas>'),e=w3_div("id-fft-controls w3-text-white",w3_half("","",f,w3_divs("",w3_div("w3-medium w3-text-aqua","<b>Audio FFT</b>"),w3_inline("w3-margin-T-8 w3-halign-space-between/",w3_select("|color:red","Function","","fft.func",fft.func,fft.func_s,"fft_func_cb"),w3_input("w3-width-64 w3-padding-smaller","Integrate time","fft.itime",fft.itime,"fft_itime_cb")),w3_select("w3-margin-T-8//|color:red","Presets","","fft.pre",fft.pre,fft.pre_s,"fft_pre_select_cb"),w3_div("id-fft-msg-fft w3-margin-T-8",w3_slider("","max","fft.maxdb",fft.maxdb,-100,20,1,"fft_maxdb_cb"),w3_slider("","min","fft.mindb",fft.mindb,-190,-30,1,"fft_mindb_cb")),w3_text("id-fft-msg-spec  w3-margin-T-8 w3-hide","Spectrum uses main control panel<br>WF tab sliders and settings"),w3_button("w3-margin-T-8","Clear","fft_clear_cb")),"id-fft-controls-left","id-fft-controls-right"));ext_panel_show(e,t,null),time_display_setup("fft"),fft.data_canvas=w3_el("id-fft-data-canvas"),fft.data_canvas.ctx=fft.data_canvas.getContext("2d"),fft.data_canvas.im=fft.data_canvas.ctx.createImageData(fft.integ_w,1),fft.data_canvas.addEventListener("mousedown",fft_mousedown,!1),fft.info_canvas=w3_el("id-fft-info-canvas"),fft.info_canvas.ctx=fft.info_canvas.getContext("2d"),FFT_environment_changed({resize:1}),fft_itime_cb("fft.itime",fft.itime),fft_clear(),fft.update_interval=setInterval(fft_update,1e3)}function FFT_environment_changed(t){if(t.mode&&ext_send("SET run="+fft.func),t.resize){var f=w3_el("id-fft-data"),e=(window.innerWidth-fft.integ_w-time_display_width())/2;f.style.left=px(e)}}function fft_alpha(){var t=16;(n=fft.info_canvas.ctx).font="12px Verdana";for(var f=0;f<4;f++){n.fillStyle="white";var e=fft.alpha_sched[0][f],_=4.5-n.measureText(e).width/2;n.fillText(e,64+48*f+_,10);e=fft.alpha_sched[1][f].toFixed(2),_=4.5-n.measureText(e).width/2;n.fillText(e,64+48*f+_,26),t=32;for(var a=1;a<=6;a++){0==f&&(n.fillStyle="white",n.fillText("slot "+a,16,t+15)),(i=fft.alpha_sched[a+2][f])==fft_a.MULT?(n.fillStyle=fft.alpha_station_colors[fft_a.NOVO-1],n.fillRect(64+48*f-5,t,5,20),n.fillStyle=fft.alpha_station_colors[fft_a.REVD-1],n.fillRect(64+48*f+2,t,5,20),n.fillStyle=fft.alpha_station_colors[fft_a.SEYD-1],n.fillRect(64+48*f+9,t,5,20)):i&&(n.fillStyle=fft.alpha_station_colors[i-1],n.fillRect(64+48*f,t,9,20)),t+=24}}t=192,n.font="12px Verdana";for(var i=0;i<=4;i++)n.fillStyle=fft.alpha_station_colors[i],n.fillRect(64,t,20,9),n.fillStyle="white",n.fillText(fft.alpha_stations[i],88,t+9),t+=16;var n=fft.data_canvas.ctx;fft.integ_w,ext_sample_rate();n.font="12px Verdana",n.fillStyle="white";for(f=0;f<4;f++){var r=fft.alpha_sched[1][f].toFixed(2),s=1e3*parseFloat(r);fft_marker(r,fft.alpha_sched[2][f],s)}}function fft_itime_cb(t,f){var e=parseFloat(f);e<1&&(e=1),e=e.toFixed(3),w3_num_cb(t,e),ext_send("SET itime="+e),fft_clear()}function fft_set_itime(t){w3_set_value("fft.itime",t),fft_itime_cb("fft.itime",t)}function fft_func_cb(t,f){switch(f=+f){case fft.func_e.SPEC:fft.spec_source_save=spec.source_wf,spec.source_wf=0,spec.source_audio=1,w3_hide("id-ext-data-container"),ext_show_spectrum();break;default:if(fft.func!=fft.func_e.SPEC)break;spec.source_wf=fft.spec_source_save,spec.source_audio=0,ext_hide_spectrum(),w3_show_block("id-ext-data-container")}fft.func=f,w3_show_hide("id-fft-msg-fft",fft.func!=fft.func_e.SPEC),w3_show_hide("id-fft-msg-spec",fft.func==fft.func_e.SPEC),fft_clear()}function fft_pre_select_cb(t,f){switch(f=+f,fft.integ_draw=!1,fft.pre=f,fft.pre){case fft.pre_4_SEC:fft_set_itime(4);break;case fft.pre_10_SEC:fft_set_itime(10);break;case fft.pre_ALPHA:ext_tune(11.5,"usb",ext_zoom.NOM_IN),ext_set_passband(300,3470),fft_set_itime(3.6);break;case fft.pre_ALPHA+1:ext_tune(40,"cw",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_ALPHA+2:ext_tune(60,"cw",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_ALPHA+3:ext_tune(66.35,"cw",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_ALPHA+4:ext_tune(68.5,"cw",ext_zoom.NOM_IN),fft_set_itime(1);break;case fft.pre_ALPHA+5:ext_tune(77.5,"cw",ext_zoom.NOM_IN),fft_set_itime(1)}}function fft_maxdb_cb(t,f,e,_){fft.integ_maxdb=parseFloat(f),w3_num_cb(t,f),w3_set_label("FFT/integrate max "+f+" dB",t)}function fft_mindb_cb(t,f,e,_){fft.integ_mindb=parseFloat(f),w3_num_cb(t,f),w3_set_label("FFT/integrate min "+f+" dB",t)}function fft_clear_cb(t,f){fft_clear(),setTimeout(function(){w3_radio_unhighlight(t)},w3_highlight_time)}function FFT_blur(){console.log("FFT_blur"),kiwi_clearInterval(fft.update_interval),spec.source_audio=0,ext_send("SET run="+fft.func_e.OFF),spec.need_clear_avg=!0}function FFT_config_html(){ext_config_html(fft,"fft","FFT","FFT configuration")}


